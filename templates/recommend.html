{% extends "base.html" %}

{% block head %}
<style>
    /* Custom styles for the recommendation page */
    .result-box {
        margin-top: 20px;
        padding: 20px;
        border-radius: 10px;
        background-color: #e6f7ff; /* Light blue/cyan for success */
        border-left: 5px solid #00a0dc; /* Stronger blue line */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: none;
    }
    .result-box h4 {
        color: #007bb5;
        font-weight: 600;
    }
    .result-box.error {
        background-color: #ffebe6; /* Light red/peach for error */
        border-left: 5px solid #ff4d4f; /* Strong red line */
    }
    .result-box.error h4 {
        color: #cf1322;
    }
    .loading-spinner {
        display: none;
    }
    h1 {
        color: #0d47a1; /* Dark blue for main title */
        font-weight: 800;
    }
    .card {
        border: 1px solid #e0e0e0; /* Subtle border for definition */
    }
    legend {
        color: #0d47a1;
        font-size: 1.25rem;
        font-weight: 600;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 5px;
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 500;
        color: #333;
    }
</style>
{% endblock %}

{% block content %}

<div class="row justify-content-center">
    <div class="col-md-11 col-lg-10">
        <div class="card p-4">
            <div class="card-body">
                <h1 class="card-title text-center mb-2">Precision Fertilizer Advisor </h1>
                <p class="text-center text-secondary mb-5">
                    Enter the parameters below for an <strong>AI-driven, tailored recommendation</strong> to optimize your crop's yield and health.
                </p>

                <form id="predictionForm" class="row g-4">

                    <!-- Environmental -->
                    <fieldset class="col-12 border p-3 rounded-3 mb-4">
                        <legend class="w-auto px-2">1. Environmental Conditions</legend>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="temperature" class="form-label">Temperature (C)</label>
                                <input type="number" step="0.01" class="form-control" id="temperature" value="25" required>
                            </div>

                            <div class="col-md-4">
                                <label for="moisture" class="form-label">Moisture (0–1)</label>
                                <input type="number" step="0.01" min="0" max="1" class="form-control" id="moisture" value="0.60" required>
                            </div>

                            <div class="col-md-4">
                                <label for="ph" class="form-label">PH Value</label>
                                <input type="number" step="0.01" class="form-control" id="ph" value="6.5" required>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Nutrients -->
                    <fieldset class="col-12 border p-3 rounded-3 mb-4">
                        <legend class="w-auto px-2">2. Soil Nutrient Levels </legend>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="nitrogen" class="form-label">Nitrogen (N) (kg/ha)</label>
                                <input type="number" step="0.01" class="form-control" id="nitrogen" value="70" required>
                            </div>
                            <div class="col-md-3">
                                <label for="phosphorous" class="form-label">Phosphorous (P) (kg/ha)</label>
                                <input type="number" step="0.01" class="form-control" id="phosphorous" value="50" required>
                            </div>
                            <div class="col-md-3">
                                <label for="potassium" class="form-label">Potassium (K) (kg/ha)</label>
                                <input type="number" step="0.01" class="form-control" id="potassium" value="50" required>
                            </div>

                            <div class="col-md-3">
                                <label for="carbon" class="form-label">Organic Carbon (%)</label>
                                <input type="number" step="0.01" class="form-control" id="carbon" value="1.5" required>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Soil & Crop -->
                    <fieldset class="col-12 border p-3 rounded-3 mb-4">
                        <legend class="w-auto px-2">3. Soil & Crop Context</legend>
                        <div class="row g-3">

                            <div class="col-md-4">
                                <label for="soil" class="form-label">Soil Type</label>
                                <select class="form-select" id="soil" required>
                                    <option value="" disabled selected>Select Soil Type</option>
                                    {% for soil in soil_options %}
                                    <option value="{{ soil }}">{{ soil }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label for="crop" class="form-label">Crop Type</label>
                                <select class="form-select" id="crop" required>
                                    <option value="" disabled selected>Select Crop</option>
                                    {% for crop in crop_options %}
                                    <option value="{{ crop }}">{{ crop }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                        </div>
                    </fieldset>

                    <!-- Submit -->
                    <div class="col-12 mt-4 text-center">
                        <button type="submit" class="btn btn-lg btn-success w-75 py-3 shadow-lg">
                            <span class="loading-spinner spinner-border spinner-border-sm me-2"></span>
                            Generate Recommendation
                        </button>
                    </div>
                </form>

                <div id="resultBox" class="result-box text-center">
                    <h4 id="resultTitle" class="mb-2">Recommended Fertilizer:</h4>
                    <p id="resultText" class="fs-2 fw-bold"></p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.getElementById('predictionForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const resultBox = document.getElementById('resultBox');
        const resultText = document.getElementById('resultText');

        // Button loading
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';
        resultBox.style.display = 'none';
        resultBox.classList.remove('error');

        // Moisture is already 0–1 (NO conversion)
        const moistureValue = parseFloat(document.getElementById('moisture').value);

        // Collect Data
        const inputData = {
            Temperature: document.getElementById('temperature').value,
            Moisture: moistureValue,
            PH: document.getElementById('ph').value,
            Nitrogen: document.getElementById('nitrogen').value,
            Phosphorous: document.getElementById('phosphorous').value,
            Potassium: document.getElementById('potassium').value,
            Carbon: document.getElementById('carbon').value,
            Soil: document.getElementById('soil').value,
            Crop: document.getElementById('crop').value
        };

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inputData)
            });

            const data = await response.json();
            resultBox.classList.add('animate__animated', 'animate__fadeIn');

            if (response.ok && data.success) {
                resultText.textContent = data.fertilizer_recommendation;
                resultBox.querySelector('h4').textContent = ' Recommended Fertilizer:';
            } else {
                resultText.textContent = data.error || 'Prediction failed.';
                resultBox.classList.add('error');
                resultBox.querySelector('h4').textContent = '⚠️ Error:';
            }

            resultBox.style.display = 'block';

        } catch (err) {
            resultBox.classList.add('error');
            resultText.textContent = 'Network Error: Could not connect to server.';
            resultBox.style.display = 'block';
            resultBox.querySelector('h4').textContent = '⚠️ Connection Error:';
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Generate Recommendation';
        }
    });
</script>
{% endblock %}
